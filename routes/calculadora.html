<svelte:head>
	<title>Calculadora</title>
</svelte:head>

<div class="dock">
	<button class="icon ion-md-checkmark-circle success" on:click="add('N')"></button>
	<button class="icon ion-md-close-circle warning" on:click="add('F')"></button>
	<button class="icon ion-md-cog spaced" on:click="config()"></button>
</div>

<p>Linhas: {vistorias.length} N: {n}. F: {vistorias.filter(obj => obj.tipo == "F").length} Tempo: {tempo}</p>

<div class={config}>
	<h1>Configurações</h1>

	<div class="container">
		<div>
			<fieldset>
				<legend>Manhã</legend>
				<label>Ativado
					<input type="checkbox" bind:checked=manha.ativado>
				</label>
				<br>
				<br>
				<div class="container">
					<label>Início:</label>
					<input type="time" bind:value=manha.inicio>
				</div>
				<br>
				<div class="container">
					<label>Fim:</label>
					<input type="time" bind:value=manha.fim>
				</div>
			</fieldset>
		</div>

		<div>
			<fieldset>
				<legend>Tarde</legend>
				<label>Ativado
					<input type="checkbox" bind:checked=tarde.ativado>
				</label>
				<br>
				<br>
				<div class="container">
					<label>Início:</label>
					<input type="time" bind:value=tarde.inicio>
				</div>
				<br>
				<div class="container">
					<label>Fim:</label>
					<input type="time" bind:value=tarde.fim>
				</div>
			</fieldset>
		</div>
	</div>
</div>


<div class={content}>
	<table>
		<tr>
			<th>Linha</th>
			<th>Tipo</th>
			<th>Hora</th>
			<th>Excluir</th>
		</tr>
		{#each vistorias as vistoria}
		<tr>
			<td>{vistorias.findIndex(obj => obj.id == vistoria.id)+1}</td>
			<td>
				{#if vistoria.tipo == "N"}
				<button class="icon ion-md-checkmark-circle success" on:click='changeTo(`${vistoria.id}`, "F")'></button>
				{:else}
				<button class="icon ion-md-close-circle warning" on:click='changeTo(`${vistoria.id}`, "N")'></button>
				{/if}
			</td>
			<td>{vistoria.hora}</td>
			<td><button class="icon ion-md-trash" on:click='remove(`${vistoria.id}`)'></button></td>
		</tr>
		{/each}
	</table>
</div>


<script>
	function timeAfter(time, duration) {
	  let [hour, minutes] = time.split(":");
	  hour = Number(hour);
	  minutes = Number(minutes);
	  duration = Number(duration);
	  if (minutes + duration >= 60) {
	    hour += 1;
	    minutes = minutes + duration - 60;
	  } else {
	    minutes += duration;
	  }
	  return `${String(hour).padStart(2, "0")}:${String(minutes).padStart(2, "0")}`;
	}

	function getDuration(start, finish) {
  	let regExp = /^(\d{1,2}):(\d{2})/;
		let h1 = Number(start.match(regExp)[1]);
		let m1 = Number(start.match(regExp)[2]);

		let h2 = Number(finish.match(regExp)[1]);
		let m2 = Number(finish.match(regExp)[2]);
		
		return ((h2-(h1+1))*60) + (60-m1) + m2;
	}

	console.log(getDuration("8:40", "11:00"));
	

	function calculaTempo(manha, tarde) {
				if (manha.ativado && tarde.ativado) {
					let minutos = getDuration(manha.inicio, manha.fim) + getDuration(tarde.inicio, tarde.fim);
					return minutos;
				} else if (manha.ativado && !tarde.ativado) {
					let minutos = getDuration(manha.inicio, manha.fim);
					return minutos;
				} else  if (manha.ativado && !tarde.ativado) {
					let minutos = getDuration(tarde.inicio, tarde.fim);
					return minutos;
				} else {
					return 0;
				}
			}

	export default {
	  helpers: {
			timeAfter,
			getDuration,
			calculaTempo
	  },
	  data() {
	    return {
	      config: "hide",
				content: "show",
				id: 0,
	      folha: 1,
	      linha: 1,
	      vistorias: [],
				hora: "08:40",
	      manha: {
	        ativado: true,
	        inicio: "08:40",
	        fim: "11:20"
	      },
	      tarde: {
	        ativado: true,
	        inicio: "14:30",
	        fim: "17:20"
	      }
	    };
		},
		computed: {
			n: ({ id, vistorias }) => { vistorias.filter(obj => obj.tipo == "N").length },
			tempo: ({ manha, tarde }) => { calculaTempo(manha, tarde); }
		},
	  methods: {
	    config() {
	      const {
	        config,
					content,
					id,
	        folha,
	        linha,
					vistorias,
					tempo,
	        hora,
	        manha,
	        tarde
	      } = this.get();
	      if (config == "show") {
	        this.set({ config: "hide" });
	        this.set({ content: "show" });
	      } else {
	        this.set({ config: "show" });
	        this.set({ content: "hide" });
				}
	    },
	    add(type) {
	      const {
	        config,
					content,
					id,
	        folha,
	        linha,
					vistorias,
					tempo,
	        hora,
	        manha,
	        tarde
				} = this.get();
				
				// Adiciona alguma aleatoriedade aos horários.
	      let randomize =
					Math.trunc(Math.random() * 3) - Math.trunc(Math.random() * 2);

	      // Registra a vistoria
	      this.set({
	        vistorias: vistorias.concat({
						id: id,
						folha: folha,
						linha: linha,
	          tipo: type,
	          hora: hora
	        })
	      });

				let n = vistorias.filter(obj => obj.tipo == "N").length;
				let f = vistorias.filter(obj => obj.tipo == "F").length;
				let fs = 2*f;
				let timeN = (tempo - fs)/n;
				console.log(tempo);
				let timeF = 2;
				console.log(fs);

	      // let time;
	      if (type == "N") {
					this.set({ hora: timeAfter(hora, timeN + randomize) });
	      } else {
	        this.set({ hora: timeAfter(hora, timeF + randomize) });
				}
	      
	      // Ajusta as folhas e linhas
				this.set({ id: id + 1 });
				this.set({ linha: linha + 1 });
	      if (linha >= 20) {
	        this.set({ folha: folha + 1 });
	        this.set({ linha: 1 });
				}
				
				
	    },
	    changeTo(id, type) {
				const {
	        config,
	        content,
					_,
					folha,
					linha,
					vistorias,
					tempo,
	        hora,
	        manha,
	        tarde
				} = this.get();
				
				let list = vistorias;
				list[id].tipo = type
				
				this.set({
	        vistorias: list
	      });
	      
			},
			remove(id) {
				const {
	        config,
	        content,
					_,
					folha,
					linha,
					vistorias,
					tempo,
	        hora,
	        manha,
	        tarde
				} = this.get();

				this.set({
	        vistorias: vistorias.filter(obj => obj.id != id)
	      });
			}
		}
	};
</script>

<style>
	button {
	  background-color: transparent;
	  border: none;
	}

	table {
	  width: 100%;
	  border-collapse: collapse;
	  margin-bottom: 80px;
	}

	th {
	  font-size: 1.3em;
	}

	tr {
	  border-bottom: 5px solid white;
	}

	td {
	  text-align: center;
	  vertical-align: middle;
	  background-color: #f6f6f6;
	  font-size: 1.4em;
	}

	.hide {
	  display: none;
	}

	.show {
	  display: block;
	}

	div > .icon {
	  font-size: 62px;
	}

	td > .icon {
	  font-size: 1.2em;
	}

	.center {
	  text-align: center;
	}

	button {
	  margin: 0px 10px 0px 10px;
	  vertical-align: middle;
	}

	.success {
	  color: #32b643;
	}

	.warning {
	  color: #e85600;
	}

	.dock {
	  position: fixed;
	  bottom: 0px;
	  right: 0px;
	  left: 0px;
	  background-color: white;
	  text-align: center;
	  -webkit-box-shadow: 0px -5px 70px 0px rgba(74, 74, 74, 0.75);
	  -moz-box-shadow: 0px -5px 70px 0px rgba(74, 74, 74, 0.75);
	  box-shadow: 0px -5px 70px 0px rgba(74, 74, 74, 0.75);
	}

	legend {
	  font-size: 1.4em;
	}
</style>