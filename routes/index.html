<svelte:head>
	<title>Calculadora</title>
</svelte:head>

<div class="dock">
	<button class="badge" on:click="add(true)" data-count={normais}><i class="icon ion-md-checkmark-circle success"></i></button>
	<button class="badge" on:click="add(false)" data-count={fechadas}><i class="icon ion-md-close-circle warning"></i></button>
	<button on:click="config()"><i class="icon ion-md-cog"></i></button>
</div>

<div class={showConfig}>
	<h1>Configurações</h1>

	{#if normais != 0}<p>Tempo médio por Vistoria N: {media}</p>{/if}

	<div class="container">
		<div>
			<fieldset>
				<legend>Manhã</legend>
				<label>Ativado
					<input type="checkbox" bind:checked=manha.ativado>
				</label>
				<br>
				<br>
				<div class="container">
					<label>Início:</label>
					<input type="time" bind:value=manha.inicio>
				</div>
				<br>
				<div class="container">
					<label>Fim:</label>
					<input type="time" bind:value=manha.fim>
				</div>
			</fieldset>
		</div>

		<div>
			<fieldset>
				<legend>Tarde</legend>
				<label>Ativado
					<input type="checkbox" bind:checked=tarde.ativado>
				</label>
				<br>
				<br>
				<div class="container">
					<label>Início:</label>
					<input type="time" bind:value=tarde.inicio>
				</div>
				<br>
				<div class="container">
					<label>Fim:</label>
					<input type="time" bind:value=tarde.fim>
				</div>
			</fieldset>
		</div>
	</div>
	{#if !(manha.ativado || tarde.ativado)}
	<p class=warning-msg>Erro. Não há período ativo. Ative ao menos um dos períodos.</p>
	{/if}
</div>


<div class={showContent}>
	<table>
		<tr>
			<th>Linha</th>
			<th>Tipo</th>
			<th>Hora</th>
			<th>Excluir</th>
		</tr>
		{#each vistorias as vistoria}
		<tr>
			<td>{vistorias.findIndex(obj => obj.id == vistoria.id)+1}</td>
			<td>
				{#if vistoria.normal}
				<button class="icon ion-md-checkmark-circle success" on:click='change(vistoria.id)'></button>
				{:else}
				<button class="icon ion-md-close-circle warning" on:click='change(vistoria.id)'></button>
				{/if}
			</td>
			<td>{vistoria.hora}</td>
			<td><button class="icon ion-md-trash" on:click='remove(vistoria.id)'></button></td>
		</tr>
		{/each}
	</table>
</div>


<script>
	function media(vistorias, manha, tarde) {
	  let normais = vistorias.filter(obj => obj.normal).length;
	  let fechadas = vistorias.filter(obj => !obj.normal).length;
	  return Math.trunc(
	    (totalDuration(manha, tarde) - fechadas * 2) / (normais - 1)
	  );
	}

	function timeObjAsStr(time) {
	  time.h = String(time.h).padStart(2, "0");
	  time.m = String(time.m).padStart(2, "0");
	  return `${time.h}:${time.m}`;
	}

	function timeStrAsObj(time) {
	  let [hours, minutes] = time.split(":");
	  return { h: Number(hours), m: Number(minutes) };
	}

	function timeDiff(time, duration) {
	  time = timeStrAsObj(time);
	  if (time.m + duration >= 60) {
	    let hours = Math.trunc((time.m + duration) / 60);
	    time.h += hours;
			time.m = time.m + duration - hours * 60;
			console.log(`Avançou: ${time.h}:${time.m}`);
		} else if (time.m + duration < 0) {
			time.h -= 1;
			time.m = 60 + duration;
			console.log(`Retornou: ${time.h}:${time.m}`);
	  } else {
			time.m += duration;
			console.log(`Normal: ${time.h}:${time.m}`);
	  }
	  return timeObjAsStr(time);
	}

	function getDuration(start, finish) {
	  start = timeStrAsObj(start);
	  finish = timeStrAsObj(finish);
	  // returns the duration in minutes between start and finish.
	  return (finish.h - (start.h + 1)) * 60 + (60 - start.m) + finish.m;
	}

	function totalDuration(manha, tarde) {
	  let durationManha = getDuration(manha.inicio, manha.fim);
	  let durationTarde = getDuration(tarde.inicio, tarde.fim);
	  let minutos = 0;
	  if (manha.ativado && tarde.ativado) {
	    minutos = durationManha + durationTarde;
	  } else if (manha.ativado && !tarde.ativado) {
	    minutos = durationManha;
	  } else if (!manha.ativado && tarde.ativado) {
	    minutos = durationTarde;
	  }
	  return minutos;
	}

	// Aleatoriedade dos horários (entre n-1 e n+1).
	function randomize(time) {
	  let diff = Math.trunc(Math.random() * 3) - 1;
	  return timeDiff(time, diff);
	}

	function horaInicio(manha, tarde) {
	  if (manha.ativado) {
	    return manha.inicio;
	  } else if (tarde.ativado) {
	    return tarde.inicio;
	  } else {
	    return "00:00";
	  }
	}

	function horaSaida(manha, tarde, hora) {
	  hora = timeStrAsObj(hora);
	  if (manha.ativado && tarde.ativado) {
	    let manhaFim = timeStrAsObj(manha.fim);
	    let tardeInicio = timeStrAsObj(tarde.inicio);
	    if (hora.h >= manhaFim.h && hora.m > manhaFim.m && hora.h < tardeInicio.h) {
	      return tarde.inicio;
	    } else {
	      return timeObjAsStr(hora);
	    }
	  } else {
	    return timeObjAsStr(hora);
	  }
	}

	function update(vistorias, manha, tarde) {
	  let mediaNormal = media(vistorias, manha, tarde);
	  if (vistorias.length > 0) {
	    let atual = randomize(horaInicio(manha, tarde));
	    vistorias = vistorias.map(vistoria => {
	      vistoria.hora = atual;
	      if (vistoria.normal) {
	        atual = randomize(
	          horaSaida(manha, tarde, timeDiff(atual, mediaNormal))
	        );
	      } else {
	        atual = randomize(horaSaida(manha, tarde, timeDiff(atual, 2)));
	      }
	      return vistoria;
	    });
	  }
	  return vistorias;
	}

	export default {
	  data() {
	    return {
	      config: false,
	      vistorias: [],
	      manha: {
	        ativado: true,
	        inicio: "08:40",
	        fim: "11:20"
	      },
	      tarde: {
	        ativado: true,
	        inicio: "14:30",
	        fim: "17:20"
	      }
	    };
	  },
	  helpers: {},
	  computed: {
	    showConfig: ({ config }) => (config ? "show" : "hide"),
	    showContent: ({ config }) => (!config ? "show" : "hide"),
	    normais: ({ vistorias }) => vistorias.filter(obj => obj.normal).length,
	    fechadas: ({ vistorias }) =>
	      vistorias.filter(obj => obj.normal == false).length,
	    media: ({ vistorias, manha, tarde }) => media(vistorias, manha, tarde),
	    update: ({ vistorias, manha, tarde }) => update(vistorias, manha, tarde)
	  },
	  methods: {
	    config() {
	      const { config, vistorias, manha, tarde } = this.get();

	      if (config) {
	        this.set({ config: false });
	      } else {
	        this.set({ config: true });
	      }
	      this.set({ vistorias: vistorias });
	    },

	    add(type) {
	      const { config, vistorias, manha, tarde } = this.get();

	      let horaEntrada = horaInicio(manha, tarde);
	      if (vistorias.length > 0) {
	        let vistoriaAnterior = vistorias[vistorias.length - 1];
	        if (vistoriaAnterior.normal) {
	          horaEntrada = timeDiff(vistoriaAnterior.hora, 15);
	        } else {
	          horaEntrada = timeDiff(vistoriaAnterior.hora, 2);
	        }
	      }

	      // Registra a vistoria
	      this.set({
	        vistorias: vistorias.concat({
	          id: vistorias.length,
	          normal: type,
	          hora: horaEntrada
	        })
	      });
	    },

	    change(id) {
	      const { config, vistorias, ..._ } = this.get();
	      this.set({
	        vistorias: vistorias.map(vistoria => {
	          if (vistoria.id == id) {
	            vistoria.normal = !vistoria.normal;
	          }
	          return vistoria;
	        })
	      });
	    },

	    remove(id) {
	      const { config, vistorias, ..._ } = this.get();

	      this.set({
	        vistorias: vistorias.filter(obj => obj.id != id)
	      });
	    }
	  }
	};
</script>

<style>
	button {
	  background-color: transparent;
	  border: none;
	}

	table {
	  width: 100%;
	  border-collapse: collapse;
	  margin-bottom: 80px;
	}

	th {
	  font-size: 1.3em;
	}

	tr {
	  border-bottom: 5px solid white;
	}

	td {
	  text-align: center;
	  vertical-align: middle;
	  background-color: #f6f6f6;
	  font-size: 1.4em;
	}

	.hide {
	  display: none;
	}

	.show {
	  display: block;
	}

	div > .icon,
	button > .icon {
	  font-size: 62px;
	}

	td > .icon {
	  font-size: 1.2em;
	}

	.center {
	  text-align: center;
	}

	button {
	  margin: 0px 10px 0px 10px;
	  vertical-align: middle;
		touch-action: manipulation;
	}

	.success {
	  color: #32b643;
	}

	.warning {
	  color: #e85600;
	}

	.warning-msg {
	  padding: 20px;
	  background-color: #e85600;
	  color: white;
	  font-weight: 700;
	  border-radius: 5px;
	}

	.dock {
	  position: fixed;
	  bottom: 0px;
	  right: 0px;
	  left: 0px;
	  background-color: white;
	  text-align: center;
	  -webkit-box-shadow: 0px -5px 70px 0px rgba(74, 74, 74, 0.75);
	  -moz-box-shadow: 0px -5px 70px 0px rgba(74, 74, 74, 0.75);
	  box-shadow: 0px -5px 70px 0px rgba(74, 74, 74, 0.75);
	}

	legend {
	  font-size: 1.4em;
	}

	/* Button Badge */
	button.badge {
	  position: relative;
	}

	button.badge:before {
	  content: attr(data-count);
	  width: 20px;
	  height: 20px;
	  line-height: 20px;
	  text-align: center;
	  display: block;
	  border-radius: 50%;
	  background: rgb(67, 151, 232);
	  border: 1px solid #ddd;
	  color: #fff;
	  position: absolute;
	  bottom: 10px;
	  right: 4px;
	}
</style>